name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: write

jobs:
  # Job pour exécuter tous les tests avec Docker Compose
  test:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔧 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔧 Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.3/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: 🔍 Debug user and permissions
        run: |
          id  # Affiche l'utilisateur et ses groupes
          ls -ld .  # Affiche les permissions du répertoire de travail
          # Ajoutez d'autres répertoires si nécessaire (ex: ls -ld ./test-data)

      - name: 🔧 Fix permissions for test directories
        run: |
          # Remplacez "test-data" par les répertoires utilisés dans docker-compose.test.yml
          mkdir -p test-data  # Crée le répertoire si nécessaire
          chmod -R 755 test-data  # Ajuste les permissions
          chown -R $(id -u):$(id -g) test-data  # Aligne avec l'UID/GID de l'utilisateur runner

      - name: 🧪 Run tests
        run: |
          export USER_UID=$(id -u)
          export USER_GID=$(id -g)
          docker-compose -f docker-compose.test.yml up --build --abort-on-container-exit


      - name: 📜 Save logs on failure
        if: failure()
        run: |
          docker-compose -f docker-compose.test.yml logs > test-logs.txt
          cat test-logs.txt

      - name: 🧹 Clean up
        if: always()
        run: |
          docker-compose -f docker-compose.test.yml down -v --rmi local

  # Job pour construire et pousser les images Docker
  docker-build-push:
    needs: [test]
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔧 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔐 Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: 🏷️ Generate Docker tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}/smart-campus-frontend
            ghcr.io/${{ github.repository }}/smart-campus-navigation-bot
            ghcr.io/${{ github.repository }}/smart-campus-lost-and-found
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=match,pattern=v(\d+\.\d+\.\d+),group=1

      - name: 🏗️ Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./Frontend
          file: ./Frontend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/smart-campus-frontend:${{ github.sha }}
            ghcr.io/${{ github.repository }}/smart-campus-frontend:latest
          labels: ${{ steps.meta.outputs.labels }}

      - name: 🏗️ Build and push navigation-bot image
        uses: docker/build-push-action@v5
        with:
          context: ./backend/navigation-bot
          file: ./backend/navigation-bot/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/smart-campus-navigation-bot:${{ github.sha }}
            ghcr.io/${{ github.repository }}/smart-campus-navigation-bot:latest
          labels: ${{ steps.meta.outputs.labels }}

      - name: 🏗️ Build and push lost-and-found image
        uses: docker/build-push-action@v5
        with:
          context: ./backend/lost-and-found
          file: ./backend/lost-and-found/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/smart-campus-lost-and-found:${{ github.sha }}
            ghcr.io/${{ github.repository }}/smart-campus-lost-and-found:latest
          labels: ${{ steps.meta.outputs.labels }}